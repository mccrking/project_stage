{% extends "base.html" %}

{% block title %}Paramètres - Central Danone{% endblock %}

{% block extra_css %}
<style>
    .settings-header {
        background: linear-gradient(135deg, #6f42c1, #495057);
        color: white;
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        position: relative;
        overflow: hidden;
    }
    
    .settings-header::before {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    
    .settings-nav {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: var(--spacing-sm);
        margin-bottom: var(--spacing-lg);
        border: 1px solid var(--border-color);
    }
    
    .settings-tab {
        background: transparent;
        border: none;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        color: var(--text-secondary);
        width: 100%;
        text-align: left;
        margin-bottom: var(--spacing-xs);
    }
    
    .settings-tab:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .settings-tab.active {
        background: var(--danone-blue);
        color: white;
    }
    
    .settings-section {
        display: none;
    }
    
    .settings-section.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .network-test-result {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border-left: 4px solid;
    }
    
    .test-success {
        background: rgba(40, 167, 69, 0.1);
        border-left-color: #28a745;
        color: #28a745;
    }
    
    .test-error {
        background: rgba(220, 53, 69, 0.1);
        border-left-color: #dc3545;
        color: #dc3545;
    }
    
    .config-assistant {
        background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(51, 136, 221, 0.1));
        border-left: 4px solid var(--danone-blue);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }
    
    .advanced-toggle {
        cursor: pointer;
        color: var(--danone-blue);
        text-decoration: none;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        background: var(--card-bg);
        transition: all var(--transition-fast);
    }
    
    .advanced-toggle:hover {
        background: var(--bg-secondary);
        text-decoration: none;
        color: var(--danone-blue);
    }
    
    .security-setting {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
    }
    
    .security-status {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    .status-secure { background: #28a745; color: white; }
    .status-warning { background: #ffc107; color: #000; }
    .status-danger { background: #dc3545; color: white; }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--danone-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    .backup-item {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        transition: all var(--transition-normal);
    }
    
    .backup-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }
    
    .wizard-step {
        display: none;
    }
    
    .wizard-step.active {
        display: block;
        animation: slideInRight 0.3s ease-in-out;
    }
    
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xl);
    }
    
    .step {
        flex: 1;
        text-align: center;
        position: relative;
    }
    
    .step::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: var(--border-color);
        z-index: 1;
    }
    
    .step:first-child::before {
        display: none;
    }
    
    .step-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--border-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        position: relative;
        z-index: 2;
        margin-bottom: var(--spacing-sm);
    }
    
    .step.completed .step-circle,
    .step.active .step-circle {
        background: var(--danone-blue);
    }
    
    .step.completed::before {
        background: var(--danone-blue);
    }
</style>
{% endblock %}

{% block content %}
<!-- Enhanced Settings Header -->
<div class="settings-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="h2 mb-2">
                <i class="fas fa-cogs me-3"></i>
                Centre de Configuration Central Danone
            </h1>
            <p class="mb-0 opacity-90">Configuration avancée et gestion du système de supervision</p>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="d-flex flex-column align-items-md-end">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-light btn-sm" onclick="launchConfigWizard()">
                        <i class="fas fa-magic me-2"></i>Assistant
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="exportConfig()">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="resetToDefaults()">
                        <i class="fas fa-undo me-2"></i>Défauts
                    </button>
                </div>
                <div class="text-white-50">
                    <small>Dernière sauvegarde</small><br>
                    <span id="settings-last-save" class="fw-bold">--:--:--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Assistant -->
<div class="config-assistant">
    <div class="row align-items-center">
        <div class="col-md-1">
            <i class="fas fa-robot fa-2x text-primary"></i>
        </div>
        <div class="col-md-11">
            <h6 class="mb-1"><i class="fas fa-magic me-2"></i>Assistant IA de Configuration</h6>
            <p class="mb-2">L'IA peut vous aider à configurer automatiquement votre réseau en détectant les paramètres optimaux.</p>
            <button class="btn btn-sm btn-primary" onclick="startAutoConfig()">
                <i class="fas fa-play me-2"></i>Démarrer la Configuration Automatique
            </button>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row">
    <!-- Settings Navigation -->
    <div class="col-lg-3">
        <div class="settings-nav">
            <h6 class="text-muted mb-3 px-3">CATÉGORIES</h6>
            <button class="settings-tab active" data-section="network">
                <i class="fas fa-network-wired me-2"></i>Réseau & Scan
            </button>
            <button class="settings-tab" data-section="alerts">
                <i class="fas fa-bell me-2"></i>Alertes & Notifications
            </button>
            <button class="settings-tab" data-section="ai">
                <i class="fas fa-brain me-2"></i>Intelligence Artificielle
            </button>
            <button class="settings-tab" data-section="security">
                <i class="fas fa-shield-alt me-2"></i>Sécurité & Accès
            </button>
            <button class="settings-tab" data-section="users">
                <i class="fas fa-users me-2"></i>Utilisateurs & Rôles
            </button>
            <button class="settings-tab" data-section="reports">
                <i class="fas fa-chart-bar me-2"></i>Rapports & Export
            </button>
            <button class="settings-tab" data-section="system">
                <i class="fas fa-server me-2"></i>Système & Performance
            </button>
            <button class="settings-tab" data-section="backup">
                <i class="fas fa-save me-2"></i>Sauvegarde & Restore
            </button>
        </div>
    </div>
    
    <!-- Settings Content -->
    <div class="col-lg-9">
        <!-- Network Settings Section -->
        <div class="settings-section active" id="network-section">
            <div class="card card-enhanced">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-network-wired me-2"></i>Configuration Réseau
                    </h5>
                    <button class="advanced-toggle" onclick="toggleAdvanced('network')">
                        <i class="fas fa-cog me-1"></i>Paramètres Avancés
                    </button>
                </div>
                <div class="card-body">
                    <form id="network-settings-form">
                        <!-- Basic Network Settings -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Plage Réseau à Scanner</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-network-wired"></i></span>
                                    <input type="text" class="form-control form-control-enhanced" 
                                           id="network-range" value="{{ network_range or '192.168.1.0/24' }}"
                                           placeholder="192.168.1.0/24">
                                    <button class="btn btn-outline-primary" type="button" onclick="detectNetwork()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="form-text">Format CIDR. Cliquez sur l'icône de recherche pour détecter automatiquement</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Intervalle de Scan</label>
                                <select class="form-select form-control-enhanced" id="scan-interval">
                                    <option value="5">5 minutes</option>
                                    <option value="15">15 minutes</option>
                                    <option value="30" selected>30 minutes</option>
                                    <option value="60">1 heure</option>
                                    <option value="120">2 heures</option>
                                    <option value="240">4 heures</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Advanced Network Settings -->
                        <div id="network-advanced" style="display: none;">
                            <hr>
                            <h6 class="text-muted mb-3">Paramètres Avancés</h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Timeout de Scan (sec)</label>
                                    <input type="number" class="form-control form-control-enhanced" 
                                           id="scan-timeout" value="10" min="1" max="60">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tentatives Max</label>
                                    <input type="number" class="form-control form-control-enhanced" 
                                           id="max-retries" value="3" min="1" max="10">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Threads Parallèles</label>
                                    <input type="number" class="form-control form-control-enhanced" 
                                           id="scan-threads" value="50" min="1" max="200">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Network Test -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Test de Configuration</h6>
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="testNetwork()">
                                    <i class="fas fa-vial me-2"></i>Tester la Configuration
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="quickScan()">
                                    <i class="fas fa-search me-2"></i>Scan Rapide
                                </button>
                            </div>
                            <div id="network-test-result"></div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-danone btn-enhanced">
                                <i class="fas fa-save me-2"></i>Sauvegarder
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-enhanced" onclick="resetNetwork()">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Alerts Settings Section -->
        <div class="settings-section" id="alerts-section">
            <div class="card card-enhanced">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bell me-2"></i>Configuration des Alertes
                    </h5>
                </div>
                <div class="card-body">
                    <form id="alerts-settings-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Seuil d'Alerte CPU (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control form-control-enhanced" 
                                           id="cpu-threshold" value="80" min="1" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Seuil d'Alerte Mémoire (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control form-control-enhanced" 
                                           id="memory-threshold" value="85" min="1" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Adresse Email de Notification</label>
                            <input type="email" class="form-control form-control-enhanced" 
                                   id="notification-email" placeholder="admin@danone.fr">
                        </div>
                        
                        <button type="submit" class="btn btn-danone btn-enhanced">
                            <i class="fas fa-save me-2"></i>Sauvegarder les Alertes
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- AI Settings Section -->
        <div class="settings-section" id="ai-section">
            <div class="card card-enhanced">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>Configuration Intelligence Artificielle
                    </h5>
                </div>
                <div class="card-body">
                    <form id="ai-settings-form">
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-ai-analysis" checked>
                                <label class="form-check-label" for="enable-ai-analysis">
                                    <strong>Activer l'Analyse IA</strong>
                                </label>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Modèle IA Principal</label>
                                <select class="form-select form-control-enhanced" id="ai-model">
                                    <option value="deepseek" selected>DeepSeek (Recommandé)</option>
                                    <option value="groq">Groq Llama</option>
                                    <option value="local">Modèle Local</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fréquence d'Analyse</label>
                                <select class="form-select form-control-enhanced" id="ai-frequency">
                                    <option value="realtime">Temps réel</option>
                                    <option value="5min">Toutes les 5 min</option>
                                    <option value="15min" selected>Toutes les 15 min</option>
                                    <option value="30min">Toutes les 30 min</option>
                                    <option value="1hour">Toutes les heures</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Clé API DeepSeek</label>
                            <div class="input-group">
                                <input type="password" class="form-control form-control-enhanced" 
                                       id="deepseek-api-key" placeholder="sk-...">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('deepseek-api-key')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-danone btn-enhanced">
                                <i class="fas fa-save me-2"></i>Sauvegarder IA
                            </button>
                            <button type="button" class="btn btn-outline-info btn-enhanced" onclick="testAI()">
                                <i class="fas fa-vial me-2"></i>Tester l'IA
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Security Settings Section -->
        <div class="settings-section" id="security-section">
            <div class="card card-enhanced">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Sécurité & Contrôle d'Accès
                    </h5>
                </div>
                <div class="card-body">
                    <div class="security-setting">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-1">Authentification à Double Facteur</h6>
                                <p class="text-muted mb-0">Protection renforcée des comptes administrateur</p>
                            </div>
                            <div>
                                <span class="security-status status-warning">Partiellement Configuré</span>
                            </div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enable-2fa">
                            <label class="form-check-label" for="enable-2fa">
                                Activer 2FA pour tous les administrateurs
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-danone btn-enhanced">
                        <i class="fas fa-shield-alt me-2"></i>Appliquer la Sécurité
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Users Settings Section -->
        <div class="settings-section" id="users-section">
            <div class="card card-enhanced">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Gestion des Utilisateurs
                    </h5>
                    <button class="btn btn-sm btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-plus me-2"></i>Nouvel Utilisateur
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-enhanced">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Rôle</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-3">AD</div>
                                            <div>
                                                <div class="fw-bold">Admin Danone</div>
                                                <div class="text-muted">admin@danone.fr</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-danger">Super Admin</span></td>
                                    <td><span class="badge bg-success">Actif</span></td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reports Settings Section -->
        <div class="settings-section" id="reports-section">
            <div class="card card-enhanced">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Configuration des Rapports
                    </h5>
                </div>
                <div class="card-body">
                    <form id="reports-settings-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fréquence de Génération</label>
                                <select class="form-select form-control-enhanced" id="report-frequency">
                                    <option value="daily">Quotidien</option>
                                    <option value="weekly" selected>Hebdomadaire</option>
                                    <option value="monthly">Mensuel</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Format</label>
                                <select class="form-select form-control-enhanced" id="report-format">
                                    <option value="pdf" selected>PDF</option>
                                    <option value="excel">Excel</option>
                                    <option value="csv">CSV</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-danone btn-enhanced">
                            <i class="fas fa-save me-2"></i>Sauvegarder les Rapports
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- System Settings Section -->
        <div class="settings-section" id="system-section">
            <div class="card card-enhanced">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-server me-2"></i>Paramètres Système
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informations Système</h6>
                            <table class="table table-sm">
                                <tr><td>Version:</td><td>2.0.0</td></tr>
                                <tr><td>Base de données:</td><td>SQLite</td></tr>
                                <tr><td>Statut:</td><td><span class="badge bg-success">Opérationnel</span></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Actions Système</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="createBackup()">
                                    <i class="fas fa-download me-2"></i>Sauvegarde
                                </button>
                                <button class="btn btn-outline-warning" onclick="clearCache()">
                                    <i class="fas fa-broom me-2"></i>Vider le Cache
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Backup Settings Section -->
        <div class="settings-section" id="backup-section">
            <div class="card card-enhanced">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-save me-2"></i>Sauvegarde & Restauration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="backup-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Sauvegarde Automatique</h6>
                                <p class="text-muted mb-0">Dernière sauvegarde: Il y a 2 heures</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="createBackup()">
                                    <i class="fas fa-plus me-2"></i>Créer
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup()">
                                    <i class="fas fa-download me-2"></i>Télécharger
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Wizard Modal -->
<div class="modal fade" id="configWizardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Assistant de Configuration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active">
                        <div class="step-circle">1</div>
                        <div class="step-label">Réseau</div>
                    </div>
                    <div class="step">
                        <div class="step-circle">2</div>
                        <div class="step-label">Alertes</div>
                    </div>
                    <div class="step">
                        <div class="step-circle">3</div>
                        <div class="step-label">Finalisation</div>
                    </div>
                </div>
                
                <!-- Wizard Steps -->
                <div class="wizard-step active" id="wizard-step-1">
                    <h6>Configuration Réseau Automatique</h6>
                    <p>L'IA va détecter automatiquement votre configuration réseau optimale.</p>
                    <div class="text-center py-4">
                        <i class="fas fa-network-wired fa-3x text-primary mb-3"></i>
                        <div id="network-detection-status">Prêt à démarrer la détection...</div>
                    </div>
                    <button class="btn btn-primary" onclick="startNetworkDetection()">
                        <i class="fas fa-play me-2"></i>Démarrer la Détection
                    </button>
                </div>
                
                <div class="wizard-step" id="wizard-step-2">
                    <h6>Configuration des Alertes</h6>
                    <p>Configuration automatique des seuils d'alerte basée sur votre infrastructure.</p>
                    <div class="text-center py-4">
                        <i class="fas fa-bell fa-3x text-warning mb-3"></i>
                        <div id="alerts-config-status">Configuration des alertes intelligentes...</div>
                    </div>
                </div>
                
                <div class="wizard-step" id="wizard-step-3">
                    <h6>Finalisation</h6>
                    <p>Configuration terminée avec succès !</p>
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <div>Votre système est maintenant configuré et optimisé.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="previousWizardStep()">
                    <i class="fas fa-arrow-left me-2"></i>Précédent
                </button>
                <button type="button" class="btn btn-primary" onclick="nextWizardStep()">
                    Suivant<i class="fas fa-arrow-right ms-2"></i>
                </button>
                <button type="button" class="btn btn-success" onclick="finishWizard()" style="display: none;">
                    <i class="fas fa-check me-2"></i>Terminer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class SettingsManager {
    constructor() {
        this.currentSection = 'network';
        this.wizardStep = 1;
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadSettings();
        this.updateLastSave();
        
        // Initialize tooltips
        if (typeof bootstrap !== 'undefined') {
            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(el => new bootstrap.Tooltip(el));
        }
    }
    
    bindEvents() {
        // Settings navigation
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const section = e.target.dataset.section;
                this.switchSection(section);
            });
        });
        
        // Form submissions
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleFormSubmit(form);
            });
        });
        
        // Auto-save functionality
        document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('change', () => {
                this.autoSave();
            });
        });
    }
    
    switchSection(section) {
        // Update navigation
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-section="${section}"]`).classList.add('active');
        
        // Update content
        document.querySelectorAll('.settings-section').forEach(sec => {
            sec.classList.remove('active');
        });
        document.getElementById(`${section}-section`).classList.add('active');
        
        this.currentSection = section;
    }
    
    handleFormSubmit(form) {
        const formData = new FormData(form);
        const settings = Object.fromEntries(formData);
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sauvegarde...';
        submitBtn.disabled = true;
        
        // Simulate save
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            window.notificationManager?.show('Paramètres sauvegardés avec succès', 'success');
            this.updateLastSave();
        }, 1500);
    }
    
    autoSave() {
        if (this.saveTimeout) {
            clearTimeout(this.saveTimeout);
        }
        
        this.saveTimeout = setTimeout(() => {
            this.updateLastSave();
        }, 2000);
    }
    
    updateLastSave() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        document.getElementById('settings-last-save').textContent = timeString;
    }
    
    loadSettings() {
        // Load settings from backend/localStorage
        console.log('Loading current settings...');
    }
}

// Utility Functions
function toggleAdvanced(section) {
    const advancedDiv = document.getElementById(`${section}-advanced`);
    const isVisible = advancedDiv.style.display !== 'none';
    
    advancedDiv.style.display = isVisible ? 'none' : 'block';
    
    const button = event.target;
    button.innerHTML = isVisible ? 
        '<i class="fas fa-cog me-1"></i>Paramètres Avancés' : 
        '<i class="fas fa-eye-slash me-1"></i>Masquer Avancés';
}

function detectNetwork() {
    const button = event.target;
    const input = document.getElementById('network-range');
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    setTimeout(() => {
        input.value = '192.168.1.0/24';
        button.innerHTML = '<i class="fas fa-search"></i>';
        button.disabled = false;
        window.notificationManager?.show('Réseau détecté automatiquement', 'success');
    }, 2000);
}

function testNetwork() {
    const resultDiv = document.getElementById('network-test-result');
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Test en cours...';
    
    setTimeout(() => {
        resultDiv.innerHTML = '<div class="test-success"><i class="fas fa-check me-2"></i>Configuration réseau valide - 254 adresses détectées</div>';
    }, 3000);
}

function quickScan() {
    window.notificationManager?.show('Scan rapide démarré...', 'info');
}

function resetNetwork() {
    if (confirm('Êtes-vous sûr de vouloir réinitialiser la configuration réseau ?')) {
        document.getElementById('network-range').value = '192.168.1.0/24';
        document.getElementById('scan-interval').value = '30';
        window.notificationManager?.show('Configuration réseau réinitialisée', 'warning');
    }
}

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = event.target;
    
    if (field.type === 'password') {
        field.type = 'text';
        button.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
        field.type = 'password';
        button.innerHTML = '<i class="fas fa-eye"></i>';
    }
}

function testAI() {
    window.notificationManager?.show('Test de l\'IA en cours...', 'info');
    
    setTimeout(() => {
        window.notificationManager?.show('Connexion IA réussie - Modèle DeepSeek opérationnel', 'success');
    }, 2000);
}

function launchConfigWizard() {
    const modal = new bootstrap.Modal(document.getElementById('configWizardModal'));
    modal.show();
}

function startAutoConfig() {
    const modal = new bootstrap.Modal(document.getElementById('configWizardModal'));
    modal.show();
}

function exportConfig() {
    window.notificationManager?.show('Export de la configuration en cours...', 'info');
    
    setTimeout(() => {
        const config = {
            network: { range: '192.168.1.0/24', interval: 30 },
            alerts: { cpu_threshold: 80, memory_threshold: 85 },
            ai: { model: 'deepseek', enabled: true }
        };
        
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'danone-settings.json';
        a.click();
        
        window.notificationManager?.show('Configuration exportée avec succès', 'success');
    }, 1000);
}

function resetToDefaults() {
    if (confirm('Êtes-vous sûr de vouloir restaurer tous les paramètres par défaut ?')) {
        window.notificationManager?.show('Paramètres restaurés aux valeurs par défaut', 'warning');
        setTimeout(() => location.reload(), 1500);
    }
}

function createBackup() {
    window.notificationManager?.show('Création de la sauvegarde...', 'info');
    setTimeout(() => {
        window.notificationManager?.show('Sauvegarde créée avec succès', 'success');
    }, 2000);
}

function downloadBackup() {
    window.notificationManager?.show('Téléchargement de la sauvegarde...', 'info');
}

function clearCache() {
    window.notificationManager?.show('Cache vidé avec succès', 'success');
}

// Initialize Settings Manager
document.addEventListener('DOMContentLoaded', function() {
    window.settingsManager = new SettingsManager();
});
</script>
{% endblock %}
