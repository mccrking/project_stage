{% extends "base.html" %}

{% block title %}Rapports - Central Danone{% endblock %}

{% block extra_css %}
<style>
    .reports-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        position: relative;
        overflow: hidden;
    }
    
    .reports-header::before {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    
    .report-template {
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        transition: all var(--transition-normal);
        cursor: pointer;
        background: var(--card-bg);
    }
    
    .report-template:hover {
        border-color: var(--danone-blue);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }
    
    .report-template.selected {
        border-color: var(--danone-blue);
        background: rgba(0, 102, 204, 0.05);
    }
    
    .report-preview {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        min-height: 400px;
        border: 1px dashed var(--border-color);
    }
    
    .report-item {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        transition: all var(--transition-normal);
    }
    
    .report-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow);
    }
    
    .report-status {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
    }
    
    .status-completed { background: #28a745; color: white; }
    .status-processing { background: #ffc107; color: #000; }
    .status-failed { background: #dc3545; color: white; }
    .status-scheduled { background: #6c757d; color: white; }
    
    .chart-container {
        height: 300px;
        position: relative;
    }
    
    .ai-insight {
        background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(51, 136, 221, 0.1));
        border-left: 4px solid var(--danone-blue);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }
    
    .quick-action-btn {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        text-align: center;
        transition: all var(--transition-normal);
        cursor: pointer;
        height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .quick-action-btn:hover {
        border-color: var(--danone-blue);
        background: rgba(0, 102, 204, 0.05);
        transform: translateY(-2px);
    }
    
    .templates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }
    
    .advanced-filters {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }
</style>
{% endblock %}

{% block content %}
<!-- Enhanced Reports Header -->
<div class="reports-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="h2 mb-2">
                <i class="fas fa-chart-bar me-3"></i>
                Centre de Rapports Central Danone
            </h1>
            <p class="mb-0 opacity-90">Génération intelligente et analyse avancée des données réseau</p>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="d-flex flex-column align-items-md-end">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-light btn-sm" onclick="showScheduledReports()">
                        <i class="fas fa-calendar-alt me-2"></i>Programmés
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshReports()">
                        <i class="fas fa-sync-alt me-2"></i>Actualiser
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="showTemplates()">
                        <i class="fas fa-magic me-2"></i>IA Assistant
                    </button>
                </div>
                <div class="text-white-50">
                    <small>Dernière génération</small><br>
                    <span id="reports-last-update" class="fw-bold">--:--:--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- IA Insights -->
<div class="ai-insight">
    <div class="row align-items-center">
        <div class="col-md-1">
            <i class="fas fa-lightbulb fa-2x text-warning"></i>
        </div>
        <div class="col-md-11">
            <h6 class="mb-1"><i class="fas fa-brain me-2"></i>Analyse IA - Recommandations</h6>
            <p class="mb-0" id="ai-recommendations">
                L'IA recommande de générer un rapport hebdomadaire de performance. 
                Détection de 15% d'augmentation du trafic réseau cette semaine.
            </p>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <h5 class="mb-3">Actions Rapides</h5>
        <div class="row">
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="quick-action-btn" onclick="generateQuickReport('daily')">
                    <i class="fas fa-calendar-day fa-2x mb-2 text-primary"></i>
                    <div class="fw-bold">Rapport<br>Journalier</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="quick-action-btn" onclick="generateQuickReport('weekly')">
                    <i class="fas fa-calendar-week fa-2x mb-2 text-success"></i>
                    <div class="fw-bold">Rapport<br>Hebdomadaire</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="quick-action-btn" onclick="generateQuickReport('performance')">
                    <i class="fas fa-tachometer-alt fa-2x mb-2 text-info"></i>
                    <div class="fw-bold">Performance<br>Réseau</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="quick-action-btn" onclick="generateQuickReport('security')">
                    <i class="fas fa-shield-alt fa-2x mb-2 text-warning"></i>
                    <div class="fw-bold">Sécurité<br>& Alertes</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="quick-action-btn" onclick="generateQuickReport('ai')">
                    <i class="fas fa-brain fa-2x mb-2 text-purple"></i>
                    <div class="fw-bold">Analyse<br>IA</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="quick-action-btn" onclick="showCustomReportBuilder()">
                    <i class="fas fa-plus fa-2x mb-2 text-secondary"></i>
                    <div class="fw-bold">Rapport<br>Personnalisé</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row">
    <!-- Report Generator -->
    <div class="col-lg-8">
        <div class="card card-enhanced">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-magic me-2"></i>Générateur de Rapports Avancé
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="showPreview()">
                        <i class="fas fa-eye me-1"></i>Aperçu
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="saveAsTemplate()">
                        <i class="fas fa-save me-1"></i>Sauvegarder
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="advanced-report-form">
                    <div class="advanced-filters">
                        <h6 class="mb-3"><i class="fas fa-filter me-2"></i>Configuration du Rapport</h6>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Type de Rapport</label>
                                <select class="form-select form-control-enhanced" id="report-type" onchange="updateReportOptions()">
                                    <option value="comprehensive">Rapport Complet</option>
                                    <option value="performance">Performance Réseau</option>
                                    <option value="security">Sécurité & Alertes</option>
                                    <option value="inventory">Inventaire Équipements</option>
                                    <option value="ai-analysis">Analyse IA</option>
                                    <option value="custom">Personnalisé</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Période</label>
                                <select class="form-select form-control-enhanced" id="report-period" onchange="updateDateRange()">
                                    <option value="today">Aujourd'hui</option>
                                    <option value="yesterday">Hier</option>
                                    <option value="last7days">7 derniers jours</option>
                                    <option value="last30days">30 derniers jours</option>
                                    <option value="thismonth">Ce mois</option>
                                    <option value="lastmonth">Mois dernier</option>
                                    <option value="custom">Période personnalisée</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Format de Sortie</label>
                                <select class="form-select form-control-enhanced" id="report-format">
                                    <option value="pdf">PDF (Recommandé)</option>
                                    <option value="excel">Excel (Données)</option>
                                    <option value="html">HTML (Interactif)</option>
                                    <option value="csv">CSV (Données brutes)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row" id="custom-date-range" style="display: none;">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date de début</label>
                                <input type="date" class="form-control form-control-enhanced" id="date-from">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date de fin</label>
                                <input type="date" class="form-control form-control-enhanced" id="date-to">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="mb-3"><i class="fas fa-layer-group me-2"></i>Sections à Inclure</h6>
                        <div class="row" id="report-sections">
                            <!-- Sections seront générées dynamiquement -->
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Description/Notes</label>
                        <textarea class="form-control form-control-enhanced" id="report-description" rows="3" 
                                  placeholder="Description du rapport, contexte, notes particulières..."></textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-danone btn-enhanced" onclick="generateReport()">
                            <i class="fas fa-rocket me-2"></i>Générer le Rapport
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-enhanced" onclick="scheduleReport()">
                            <i class="fas fa-calendar-plus me-2"></i>Programmer
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-enhanced" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Statistics & Recent Reports -->
    <div class="col-lg-4">
        <!-- Statistics -->
        <div class="card card-enhanced mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Statistiques des Rapports
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="stat-number-enhanced text-primary" id="total-reports">{{ total_reports or 0 }}</div>
                        <div class="stat-label-enhanced">Total</div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-number-enhanced text-success" id="reports-this-month">{{ reports_month or 0 }}</div>
                        <div class="stat-label-enhanced">Ce Mois</div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-number-enhanced text-info" id="scheduled-reports">{{ scheduled_count or 0 }}</div>
                        <div class="stat-label-enhanced">Programmés</div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-number-enhanced text-warning" id="processing-reports">{{ processing_count or 0 }}</div>
                        <div class="stat-label-enhanced">En Cours</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="reportsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Reports -->
        <div class="card card-enhanced">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>Rapports Récents
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="showAllReports()">
                    Voir tout
                </button>
            </div>
            <div class="card-body p-0">
                <div id="recent-reports-list">
                    <!-- Liste sera chargée dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>
                </div>
                
                <hr>
                
                <h6>Types de rapports</h6>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Journaliers</span>
                        <span class="badge bg-primary" id="daily-count">0</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Hebdomadaires</span>
                        <span class="badge bg-info" id="weekly-count">0</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Mensuels</span>
                        <span class="badge bg-warning" id="monthly-count">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Liste des rapports -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-list me-2"></i>
                    Rapports disponibles
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="btn-refresh-reports">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="report-filter" id="filter-all-reports" checked>
                        <label class="btn btn-outline-secondary" for="filter-all-reports">Tous</label>
                        
                        <input type="radio" class="btn-check" name="report-filter" id="filter-pdf">
                        <label class="btn btn-outline-secondary" for="filter-pdf">PDF</label>
                        
                        <input type="radio" class="btn-check" name="report-filter" id="filter-excel">
                        <label class="btn btn-outline-secondary" for="filter-excel">Excel</label>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="reports-table">
                        <thead>
                            <tr>
                                <th>Nom du fichier</th>
                                <th>Type</th>
                                <th>Taille</th>
                                <th>Date de création</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-tbody">
                            <!-- Le contenu sera chargé dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Modals -->
<!-- Report Templates Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-enhanced">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Assistant IA - Modèles de Rapports
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="templates-grid" id="templates-grid">
                    <!-- Templates générés dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content modal-enhanced">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Aperçu du Rapport
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="exportPreview()">
                        <i class="fas fa-download me-1"></i>Exporter
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div id="preview-content" class="report-preview">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Report Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content modal-enhanced">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus me-2"></i>Programmer le Rapport
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="schedule-form">
                    <div class="mb-3">
                        <label class="form-label">Fréquence</label>
                        <select class="form-select form-control-enhanced" id="schedule-frequency">
                            <option value="daily">Quotidien</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="monthly">Mensuel</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Heure d'exécution</label>
                        <input type="time" class="form-control form-control-enhanced" id="schedule-time" value="08:00">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email de notification</label>
                        <input type="email" class="form-control form-control-enhanced" id="schedule-email" 
                               placeholder="admin@danone.com">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                    <i class="fas fa-save me-2"></i>Programmer
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Enhanced Reports Manager
class ReportsManager {
    constructor() {
        this.reportSections = {
            comprehensive: [
                { id: 'executive-summary', name: 'Résumé Exécutif', checked: true },
                { id: 'network-health', name: 'État de Santé Réseau', checked: true },
                { id: 'device-inventory', name: 'Inventaire des Équipements', checked: true },
                { id: 'performance-metrics', name: 'Métriques de Performance', checked: true },
                { id: 'alerts-analysis', name: 'Analyse des Alertes', checked: true },
                { id: 'ai-insights', name: 'Insights IA', checked: true },
                { id: 'recommendations', name: 'Recommandations', checked: true },
                { id: 'trends-forecast', name: 'Tendances & Prévisions', checked: false }
            ],
            performance: [
                { id: 'bandwidth-usage', name: 'Utilisation Bande Passante', checked: true },
                { id: 'latency-analysis', name: 'Analyse Latence', checked: true },
                { id: 'throughput-metrics', name: 'Métriques de Débit', checked: true },
                { id: 'bottlenecks', name: 'Points de Congestion', checked: true },
                { id: 'performance-trends', name: 'Tendances Performance', checked: false }
            ],
            security: [
                { id: 'security-alerts', name: 'Alertes de Sécurité', checked: true },
                { id: 'threat-analysis', name: 'Analyse des Menaces', checked: true },
                { id: 'compliance-status', name: 'État de Conformité', checked: true },
                { id: 'access-logs', name: 'Logs d\'Accès', checked: false }
            ]
        };
        this.recentReports = [];
        this.init();
    }

    init() {
        this.bindEvents();
        this.initializeChart();
        this.loadRecentReports();
        this.updateReportOptions();
        this.setDefaultDates();
        this.startAutoRefresh();
        this.loadAIRecommendations();
    }

    bindEvents() {
        // Global functions
        window.generateQuickReport = (type) => this.generateQuickReport(type);
        window.showCustomReportBuilder = () => this.showCustomReportBuilder();
        window.showTemplates = () => this.showTemplates();
        window.generateReport = () => this.generateReport();
        window.scheduleReport = () => this.scheduleReport();
        window.showPreview = () => this.showPreview();
        window.refreshReports = () => this.loadRecentReports();
        window.updateReportOptions = () => this.updateReportOptions();
        window.updateDateRange = () => this.updateDateRange();
        window.resetForm = () => this.resetForm();
        window.saveAsTemplate = () => this.saveAsTemplate();
        window.showScheduledReports = () => this.showScheduledReports();
        window.showAllReports = () => this.showAllReports();
        window.saveSchedule = () => this.saveSchedule();
        window.exportPreview = () => this.exportPreview();
    }

    updateReportOptions() {
        const reportType = document.getElementById('report-type').value;
        const sectionsContainer = document.getElementById('report-sections');
        
        const sections = this.reportSections[reportType] || this.reportSections.comprehensive;
        
        const sectionsHTML = sections.map(section => `
            <div class="col-md-6 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           id="section-${section.id}" ${section.checked ? 'checked' : ''}>
                    <label class="form-check-label" for="section-${section.id}">
                        ${section.name}
                    </label>
                </div>
            </div>
        `).join('');
        
        sectionsContainer.innerHTML = sectionsHTML;
    }

    updateDateRange() {
        const period = document.getElementById('report-period').value;
        const customRange = document.getElementById('custom-date-range');
        const dateFrom = document.getElementById('date-from');
        const dateTo = document.getElementById('date-to');
        
        if (period === 'custom') {
            customRange.style.display = 'block';
            return;
        }
        
        customRange.style.display = 'none';
        
        const today = new Date();
        const endDate = new Date(today);
        let startDate = new Date(today);
        
        switch (period) {
            case 'today':
                startDate = new Date(today);
                break;
            case 'yesterday':
                startDate.setDate(today.getDate() - 1);
                endDate.setDate(today.getDate() - 1);
                break;
            case 'last7days':
                startDate.setDate(today.getDate() - 7);
                break;
            case 'last30days':
                startDate.setDate(today.getDate() - 30);
                break;
            case 'thismonth':
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                break;
            case 'lastmonth':
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                break;
        }
        
        dateFrom.value = startDate.toISOString().split('T')[0];
        dateTo.value = endDate.toISOString().split('T')[0];
    }

    setDefaultDates() {
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('date-from').value = lastWeek.toISOString().split('T')[0];
        document.getElementById('date-to').value = today.toISOString().split('T')[0];
    }

    async generateQuickReport(type) {
        const loadingId = this.showLoadingNotification(`Génération du rapport ${type}...`);
        
        try {
            const response = await fetch('/api/reports/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: type,
                    format: 'pdf',
                    period: type === 'daily' ? 'today' : 'last7days',
                    sections: this.getDefaultSections(type)
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.notificationManager?.success(`Rapport ${type} généré avec succès!`);
                this.downloadReport(result.report_url, result.filename);
                this.loadRecentReports();
            } else {
                throw new Error(result.message || 'Erreur génération rapport');
            }
        } catch (error) {
            window.notificationManager?.error(`Erreur: ${error.message}`);
        } finally {
            window.notificationManager?.hide(loadingId);
        }
    }

    async generateReport() {
        const form = document.getElementById('advanced-report-form');
        const formData = this.collectFormData();
        
        if (!this.validateForm(formData)) {
            return;
        }
        
        const loadingId = this.showLoadingNotification('Génération du rapport en cours...');
        
        try {
            const response = await fetch('/api/reports/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.notificationManager?.success('Rapport généré avec succès!');
                
                if (result.report_url) {
                    this.downloadReport(result.report_url, result.filename);
                }
                
                this.loadRecentReports();
                this.updateStatistics();
            } else {
                throw new Error(result.message || 'Erreur génération rapport');
            }
        } catch (error) {
            window.notificationManager?.error(`Erreur: ${error.message}`);
        } finally {
            window.notificationManager?.hide(loadingId);
        }
    }

    collectFormData() {
        const sections = [];
        document.querySelectorAll('#report-sections input[type="checkbox"]:checked').forEach(checkbox => {
            sections.push(checkbox.id.replace('section-', ''));
        });
        
        return {
            type: document.getElementById('report-type').value,
            period: document.getElementById('report-period').value,
            format: document.getElementById('report-format').value,
            dateFrom: document.getElementById('date-from').value,
            dateTo: document.getElementById('date-to').value,
            description: document.getElementById('report-description').value,
            sections: sections
        };
    }

    validateForm(formData) {
        if (!formData.sections.length) {
            window.notificationManager?.warning('Veuillez sélectionner au moins une section');
            return false;
        }
        
        if (formData.period === 'custom' && (!formData.dateFrom || !formData.dateTo)) {
            window.notificationManager?.warning('Veuillez sélectionner les dates de début et de fin');
            return false;
        }
        
        if (formData.period === 'custom' && new Date(formData.dateFrom) > new Date(formData.dateTo)) {
            window.notificationManager?.warning('La date de début doit être antérieure à la date de fin');
            return false;
        }
        
        return true;
    }

    showLoadingNotification(message) {
        return window.notificationManager?.info(message, 0); // 0 = permanent
    }

    downloadReport(url, filename) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async loadRecentReports() {
        try {
            const response = await fetch('/api/reports');
            const data = await response.json();
            this.recentReports = data.reports || [];
            this.renderRecentReports();
            this.updateStatistics();
        } catch (error) {
            console.error('Erreur chargement rapports:', error);
        }
    }

    renderRecentReports() {
        const container = document.getElementById('recent-reports-list');
        
        if (this.recentReports.length === 0) {
            container.innerHTML = `
                <div class="p-3 text-center text-muted">
                    <i class="fas fa-file-alt fa-2x mb-2"></i>
                    <p>Aucun rapport récent</p>
                </div>
            `;
            return;
        }
        
        const reportsHTML = this.recentReports.slice(0, 5).map(report => {
            const statusClass = this.getStatusClass(report.status);
            const timeAgo = this.getTimeAgo(report.created_at);
            
            return `
                <div class="report-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-file-${report.format === 'pdf' ? 'pdf' : 'excel'} me-2 text-${report.format === 'pdf' ? 'danger' : 'success'}"></i>
                                <div class="fw-bold">${report.name}</div>
                                <span class="report-status ${statusClass} ms-2">${this.getStatusText(report.status)}</span>
                            </div>
                            <div class="text-muted small">
                                ${report.description || 'Rapport automatisé'} • ${timeAgo}
                            </div>
                        </div>
                        <div class="ms-2">
                            ${report.status === 'completed' ? `
                                <button class="btn btn-sm btn-outline-primary" onclick="downloadReport('${report.download_url}', '${report.filename}')">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = reportsHTML;
    }

    getStatusClass(status) {
        const classes = {
            'completed': 'status-completed',
            'processing': 'status-processing',
            'failed': 'status-failed',
            'scheduled': 'status-scheduled'
        };
        return classes[status] || 'status-processing';
    }

    getStatusText(status) {
        const texts = {
            'completed': 'Terminé',
            'processing': 'En cours',
            'failed': 'Échec',
            'scheduled': 'Programmé'
        };
        return texts[status] || 'Inconnu';
    }

    getTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days}j`;
        if (hours > 0) return `${hours}h`;
        if (minutes > 0) return `${minutes}min`;
        return 'maintenant';
    }

    initializeChart() {
        const ctx = document.getElementById('reportsChart');
        if (!ctx) return;

        this.chart = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['PDF', 'Excel', 'HTML', 'CSV'],
                datasets: [{
                    data: [45, 25, 20, 10],
                    backgroundColor: [
                        '#dc3545',
                        '#28a745',
                        '#17a2b8',
                        '#ffc107'
                    ],
                    borderWidth: 2,
                    borderColor: 'var(--card-bg)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    updateStatistics() {
        const total = this.recentReports.length;
        const thisMonth = this.recentReports.filter(r => 
            new Date(r.created_at).getMonth() === new Date().getMonth()
        ).length;
        const scheduled = this.recentReports.filter(r => r.status === 'scheduled').length;
        const processing = this.recentReports.filter(r => r.status === 'processing').length;

        document.getElementById('total-reports').textContent = total;
        document.getElementById('reports-this-month').textContent = thisMonth;
        document.getElementById('scheduled-reports').textContent = scheduled;
        document.getElementById('processing-reports').textContent = processing;
    }

    async loadAIRecommendations() {
        try {
            const response = await fetch('/api/ai/recommendations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ context: 'reports' })
            });
            
            const data = await response.json();
            if (data.recommendations) {
                document.getElementById('ai-recommendations').textContent = data.recommendations;
            }
        } catch (error) {
            console.error('Erreur chargement recommandations IA:', error);
        }
    }

    showPreview() {
        const formData = this.collectFormData();
        if (!this.validateForm(formData)) return;
        
        // Génération de l'aperçu
        const previewContent = this.generatePreviewContent(formData);
        document.getElementById('preview-content').innerHTML = previewContent;
        
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();
    }

    generatePreviewContent(formData) {
        return `
            <div class="p-4">
                <div class="text-center mb-4">
                    <h3>Rapport ${formData.type.charAt(0).toUpperCase() + formData.type.slice(1)}</h3>
                    <p class="text-muted">Période: ${formData.dateFrom} au ${formData.dateTo}</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3 text-center">
                        <div class="h4 text-primary">156</div>
                        <div class="small text-muted">Équipements Actifs</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-success">98.5%</div>
                        <div class="small text-muted">Disponibilité</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-warning">12</div>
                        <div class="small text-muted">Alertes</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-info">2.1GB</div>
                        <div class="small text-muted">Trafic Moyen</div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5>Sections incluses:</h5>
                    <ul>
                        ${formData.sections.map(section => `<li>${this.getSectionName(section)}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Ceci est un aperçu simplifié. Le rapport complet contiendra des graphiques détaillés et des analyses approfondies.
                </div>
            </div>
        `;
    }

    getSectionName(sectionId) {
        const allSections = Object.values(this.reportSections).flat();
        const section = allSections.find(s => s.id === sectionId);
        return section ? section.name : sectionId;
    }

    getDefaultSections(type) {
        const defaults = {
            daily: ['executive-summary', 'network-health', 'alerts-analysis'],
            weekly: ['executive-summary', 'network-health', 'performance-metrics', 'alerts-analysis'],
            performance: ['bandwidth-usage', 'latency-analysis', 'throughput-metrics'],
            security: ['security-alerts', 'threat-analysis', 'compliance-status'],
            ai: ['ai-insights', 'recommendations', 'trends-forecast']
        };
        return defaults[type] || defaults.daily;
    }

    scheduleReport() {
        const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        modal.show();
    }

    async saveSchedule() {
        const formData = this.collectFormData();
        const scheduleData = {
            ...formData,
            frequency: document.getElementById('schedule-frequency').value,
            time: document.getElementById('schedule-time').value,
            email: document.getElementById('schedule-email').value
        };
        
        try {
            const response = await fetch('/api/reports/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(scheduleData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.notificationManager?.success('Rapport programmé avec succès!');
                bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                this.loadRecentReports();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            window.notificationManager?.error(`Erreur: ${error.message}`);
        }
    }

    resetForm() {
        document.getElementById('advanced-report-form').reset();
        this.setDefaultDates();
        this.updateReportOptions();
        document.getElementById('report-period').value = 'last7days';
        this.updateDateRange();
    }

    startAutoRefresh() {
        setInterval(() => {
            if (!document.hidden) {
                this.loadRecentReports();
            }
        }, 60000); // Refresh every minute
    }

    showTemplates() {
        const modal = new bootstrap.Modal(document.getElementById('templatesModal'));
        modal.show();
    }

    showCustomReportBuilder() {
        document.getElementById('report-type').value = 'custom';
        this.updateReportOptions();
        document.getElementById('advanced-report-form').scrollIntoView({ behavior: 'smooth' });
    }

    showScheduledReports() {
        window.notificationManager?.info('Fonctionnalité en développement');
    }

    showAllReports() {
        window.notificationManager?.info('Fonctionnalité en développement');
    }

    saveAsTemplate() {
        window.notificationManager?.info('Template sauvegardé');
    }

    exportPreview() {
        window.notificationManager?.info('Export de l\'aperçu en cours...');
    }
}

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    window.reportsManager = new ReportsManager();
});
</script>
{% endblock %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation des dates
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('date-from').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('date-to').value = today.toISOString().split('T')[0];
    
    // Charger la liste des rapports
    loadReports();
    
    // Gestion du formulaire de génération
    document.getElementById('report-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            type: document.getElementById('report-type').value,
            format: document.getElementById('report-format').value,
            date_from: document.getElementById('date-from').value,
            date_to: document.getElementById('date-to').value,
            description: document.getElementById('report-description').value
        };
        
        generateReport(formData);
    });
    
    // Aperçu du rapport
    document.getElementById('btn-preview').addEventListener('click', function() {
        const formData = {
            type: document.getElementById('report-type').value,
            format: document.getElementById('report-format').value,
            date_from: document.getElementById('date-from').value,
            date_to: document.getElementById('date-to').value,
            description: document.getElementById('report-description').value
        };
        
        showPreview(formData);
    });
    
    // Actualisation de la liste
    document.getElementById('btn-refresh-reports').addEventListener('click', function() {
        loadReports();
    });
    
    // Filtrage des rapports
    document.querySelectorAll('input[name="report-filter"]').forEach(radio => {
        radio.addEventListener('change', function() {
            filterReports(this.id);
        });
    });
    
    function generateReport(formData) {
        const button = document.getElementById('btn-generate');
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Génération...';
        button.disabled = true;
        
        fetch('/api/reports/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                // Télécharger le fichier
                window.open(`/download/${data.filename}`, '_blank');
                // Recharger la liste
                setTimeout(() => loadReports(), 1000);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'Erreur lors de la génération: ' + error.message);
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function showPreview(formData) {
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        const content = document.getElementById('preview-content');
        
        content.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p>Préparation de l'aperçu...</p>
            </div>
        `;
        
        modal.show();
        
        // Simuler la génération d'un aperçu
        setTimeout(() => {
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Type:</h6>
                        <p>${formData.type}</p>
                        <h6>Format:</h6>
                        <p>${formData.format.toUpperCase()}</p>
                        <h6>Période:</h6>
                        <p>${formData.date_from} à ${formData.date_to}</p>
                        ${formData.description ? `<h6>Description:</h6><p>${formData.description}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6>Statistiques:</h6>
                        <ul>
                            <li>Équipements surveillés</li>
                            <li>Scans effectués</li>
                            <li>Alertes générées</li>
                        </ul>
                    </div>
                </div>
            `;
        }, 2000);
    }
    
    function loadReports() {
        // Charger les rapports depuis l'API
        fetch('/api/reports/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayReports(data.reports);
                    updateStatistics(data.reports);
                } else {
                    showAlert('danger', 'Erreur lors du chargement des rapports: ' + data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Erreur lors du chargement des rapports: ' + error.message);
                // En cas d'erreur, afficher un tableau vide
                displayReports([]);
                updateStatistics([]);
            });
    }
    
    function displayReports(reports) {
        const tbody = document.getElementById('reports-tbody');
        tbody.innerHTML = '';
        
        reports.forEach(report => {
            const row = document.createElement('tr');
            row.className = 'report-row';
            row.dataset.format = report.format;
            
            row.innerHTML = `
                <td>
                    <i class="fas fa-file-${report.format === 'pdf' ? 'pdf' : 'excel'} me-2 text-${report.format === 'pdf' ? 'danger' : 'success'}"></i>
                    <strong>${report.filename}</strong>
                </td>
                <td>
                    <span class="badge bg-${report.format === 'pdf' ? 'danger' : 'success'}">${report.type}</span>
                </td>
                <td>${report.size}</td>
                <td>${formatDate(report.created)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-download" 
                                data-filename="${report.filename}"
                                title="Télécharger">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-outline-info btn-preview-report"
                                data-filename="${report.filename}"
                                title="Aperçu">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-delete-report"
                                data-filename="${report.filename}"
                                title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Ajouter les événements aux boutons
        addReportButtonEvents();
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    function addReportButtonEvents() {
        // Téléchargement
        document.querySelectorAll('.btn-download').forEach(btn => {
            btn.addEventListener('click', function() {
                const filename = this.dataset.filename;
                window.open(`/download/${filename}`, '_blank');
            });
        });
        
        // Suppression
        document.querySelectorAll('.btn-delete-report').forEach(btn => {
            btn.addEventListener('click', function() {
                const filename = this.dataset.filename;
                if (confirm(`Êtes-vous sûr de vouloir supprimer "${filename}" ?`)) {
                    deleteReport(filename);
                }
            });
        });
    }
    
    function deleteReport(filename) {
        fetch(`/api/reports/delete/${filename}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Rapport supprimé avec succès');
                loadReports();
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'Erreur lors de la suppression: ' + error.message);
        });
    }
    
    function filterReports(filterId) {
        const rows = document.querySelectorAll('.report-row');
        const filter = filterId.replace('filter-', '').replace('-reports', '');
        
        rows.forEach(row => {
            const format = row.dataset.format;
            
            if (filter === 'all' || format === filter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function updateStatistics(reports) {
        const totalReports = reports.length;
        const thisMonth = new Date().getMonth();
        const reportsThisMonth = reports.filter(r => {
            const reportMonth = new Date(r.created).getMonth();
            return reportMonth === thisMonth;
        }).length;
        
        const dailyCount = reports.filter(r => r.report_type === 'Journalier').length;
        const weeklyCount = reports.filter(r => r.report_type === 'Hebdomadaire').length;
        const monthlyCount = reports.filter(r => r.report_type === 'Mensuel').length;
        
        document.getElementById('total-reports').textContent = totalReports;
        document.getElementById('reports-this-month').textContent = reportsThisMonth;
        document.getElementById('daily-count').textContent = dailyCount;
        document.getElementById('weekly-count').textContent = weeklyCount;
        document.getElementById('monthly-count').textContent = monthlyCount;
    }
});
</script>
{% endblock %} 