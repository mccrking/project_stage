{% extends "base.html" %}

{% block title %}Paramètres - Central Danone{% endblock %}

{% block content %}
<div class="row">
    <!-- En-tête -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Paramètres
                </h1>
                <p class="text-muted mb-0">Configuration du système de supervision</p>
            </div>
        </div>
    </div>
</div>

<!-- Paramètres réseau -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-network-wired me-2"></i>
                Configuration réseau
            </div>
            <div class="card-body">
                <form id="network-settings-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="network-range" class="form-label">Plage réseau à scanner</label>
                            <input type="text" class="form-control" id="network-range" 
                                   value="192.168.1.0/24" required
                                   placeholder="ex: 192.168.1.0/24">
                            <div class="form-text">Format CIDR (ex: 192.168.1.0/24 pour 254 adresses)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="scan-interval" class="form-label">Intervalle de scan (minutes)</label>
                            <select class="form-select" id="scan-interval" required>
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60" selected>1 heure</option>
                                <option value="120">2 heures</option>
                                <option value="240">4 heures</option>
                                <option value="480">8 heures</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="scan-timeout" class="form-label">Timeout de scan (secondes)</label>
                            <input type="number" class="form-control" id="scan-timeout" 
                                   value="10" min="1" max="60" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="max-retries" class="form-label">Nombre de tentatives</label>
                            <input type="number" class="form-control" id="max-retries" 
                                   value="2" min="1" max="5" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enable-auto-scan" checked>
                            <label class="form-check-label" for="enable-auto-scan">
                                Activer le scan automatique
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Sauvegarder les paramètres réseau
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Informations réseau -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>
                Informations réseau
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Plage actuelle</h6>
                    <p class="mb-1"><strong>Réseau:</strong> <span id="current-network">192.168.1.0/24</span></p>
                    <p class="mb-1"><strong>Masque:</strong> <span id="current-mask">255.255.255.0</span></p>
                    <p class="mb-1"><strong>Adresses:</strong> <span id="current-addresses">254</span></p>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <h6>Statut du scan</h6>
                    <p class="mb-1">
                        <span class="badge bg-success" id="scan-status">Actif</span>
                        <small class="text-muted ms-2">Prochain scan dans <span id="next-scan">45 min</span></small>
                    </p>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <h6>Performance</h6>
                    <p class="mb-1"><strong>Durée moyenne:</strong> <span id="avg-duration">2.3s</span></p>
                    <p class="mb-1"><strong>Dernier scan:</strong> <span id="last-scan-time">Il y a 15 min</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration des alertes par email -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-bell me-2"></i>
                Configuration des alertes
            </div>
            <div class="card-body">
                <form id="alert-settings-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="alert-threshold" class="form-label">Seuil d'alerte (%)</label>
                            <input type="number" class="form-control" id="alert-threshold" 
                                   value="85" min="0" max="100">
                            <div class="form-text">Alerte si la disponibilité descend sous ce seuil</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="alert-email" class="form-label">Email pour les alertes</label>
                            <input type="email" class="form-control" id="alert-email" 
                                   placeholder="mehdi.chmiti2000@gmail.com">
                            <div class="form-text">Email qui recevra les alertes simples</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Types d'alertes</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alert-device-offline" checked>
                            <label class="form-check-label" for="alert-device-offline">
                                Appareil hors ligne
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alert-device-online" checked>
                            <label class="form-check-label" for="alert-device-online">
                                Appareil de retour en ligne
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alert-low-uptime" checked>
                            <label class="form-check-label" for="alert-low-uptime">
                                Disponibilité faible
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alert-scan-failed">
                            <label class="form-check-label" for="alert-scan-failed">
                                Échec de scan
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Sauvegarder les paramètres d'alertes
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Test d'alerte -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-test-tube me-2"></i>
                Test des alertes
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Tester la configuration des alertes</p>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-warning" id="btn-test-alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Tester une alerte
                    </button>
                    
                    <button class="btn btn-outline-info" id="btn-test-email">
                        <i class="fas fa-envelope me-2"></i>
                        Tester l'email simple
                    </button>
                </div>
                
                <hr>
            </div>
        </div>
    </div>
</div>

<!-- Paramètres de rapports -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-alt me-2"></i>
                Configuration des rapports
            </div>
            <div class="card-body">
                <form id="report-settings-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="auto-report" class="form-label">Rapport automatique</label>
                            <select class="form-select" id="auto-report">
                                <option value="none">Aucun</option>
                                <option value="daily" selected>Journalier</option>
                                <option value="weekly">Hebdomadaire</option>
                                <option value="monthly">Mensuel</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="report-format" class="form-label">Format par défaut</label>
                            <select class="form-select" id="report-format">
                                <option value="pdf" selected>PDF</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="report-time" class="form-label">Heure de génération</label>
                            <input type="time" class="form-control" id="report-time" value="08:00">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="report-retention" class="form-label">Rétention (jours)</label>
                            <input type="number" class="form-control" id="report-retention" 
                                   value="30" min="1" max="365">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include-charts" checked>
                            <label class="form-check-label" for="include-charts">
                                Inclure les graphiques dans les rapports
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include-alerts" checked>
                            <label class="form-check-label" for="include-alerts">
                                Inclure l'historique des alertes
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Sauvegarder les paramètres de rapports
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Statistiques des rapports -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>
                Statistiques des rapports
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="stat-number text-primary">12</div>
                        <div class="stat-label">Ce mois</div>
                    </div>
                    <div class="col-6">
                        <div class="stat-number text-success">2.3 MB</div>
                        <div class="stat-label">Taille moyenne</div>
                    </div>
                </div>
                
                <hr>
                
                <h6>Prochain rapport</h6>
                <p class="mb-2">
                    <strong>Type:</strong> Journalier<br>
                    <strong>Format:</strong> PDF<br>
                    <strong>Heure:</strong> 08:00 (demain)<br>
                    <strong>Statut:</strong> <span class="badge bg-success">Programmé</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Paramètres système -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-server me-2"></i>
                Paramètres système
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informations système</h6>
                        <table class="table table-sm">
                            <tr><td>Version:</td><td>1.0.0</td></tr>
                            <tr><td>Base de données:</td><td>SQLite</td></tr>
                            <tr><td>Dernière mise à jour:</td><td>2024-12-01</td></tr>
                            <tr><td>Statut:</td><td><span class="badge bg-success">Opérationnel</span></td></tr>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Actions système</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" id="btn-backup">
                                <i class="fas fa-download me-2"></i>
                                Sauvegarde de la base de données
                            </button>
                            
                            <button class="btn btn-outline-warning" id="btn-clear-cache">
                                <i class="fas fa-broom me-2"></i>
                                Vider le cache
                            </button>
                            
                            <button class="btn btn-outline-danger" id="btn-reset-settings">
                                <i class="fas fa-undo me-2"></i>
                                Réinitialiser les paramètres
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration email pour alertes -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-envelope me-2"></i>
                Configuration des alertes par email
            </div>
            <div class="card-body">
                <form id="email-settings-form">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email-enabled">
                            <label class="form-check-label" for="email-enabled">
                                Activer les alertes par email
                            </label>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="smtp-server" class="form-label">Serveur SMTP</label>
                            <input type="text" class="form-control" id="smtp-server" 
                                   value="smtp.gmail.com" placeholder="smtp.gmail.com">
                            <div class="form-text">Serveur SMTP (ex: smtp.gmail.com, smtp.outlook.com)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="smtp-port" class="form-label">Port SMTP</label>
                            <input type="number" class="form-control" id="smtp-port" 
                                   value="587" placeholder="587">
                            <div class="form-text">Port SMTP (587 pour TLS, 465 pour SSL)</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email-username" class="form-label">Nom d'utilisateur</label>
                            <input type="email" class="form-control" id="email-username" 
                                   placeholder="votre.email@gmail.com">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="email-password" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="email-password" 
                                   placeholder="Mot de passe ou mot de passe d'application">
                            <div class="form-text">Pour Gmail, utilisez un mot de passe d'application</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="from-email" class="form-label">Email d'expédition</label>
                            <input type="email" class="form-control" id="from-email" 
                                   placeholder="supervision@centraldanone.com">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="to-email" class="form-label">Email de destination</label>
                            <input type="email" class="form-control" id="to-email" 
                                   placeholder="admin@centraldanone.com" required>
                            <div class="form-text">Email qui recevra les alertes</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Sauvegarder la configuration email
                        </button>
                        
                        <button type="button" class="btn btn-outline-info" id="btn-test-email-config">
                            <i class="fas fa-paper-plane me-2"></i>
                            Tester la configuration
                        </button>
                        
                        <button type="button" class="btn btn-outline-warning" id="btn-send-test-alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Envoyer une alerte de test
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Aide configuration email -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-envelope me-2"></i>
                Configuration email
            </div>
            <div class="card-body">
                <h6>Configuration Gmail</h6>
                <ul class="small">
                    <li>Serveur: smtp.gmail.com</li>
                    <li>Port: 587</li>
                    <li>Activer l'authentification à 2 facteurs</li>
                    <li>Générer un mot de passe d'application</li>
                </ul>
                
                <hr>
                
                <h6>Configuration Outlook</h6>
                <ul class="small">
                    <li>Serveur: smtp-mail.outlook.com</li>
                    <li>Port: 587</li>
                    <li>Utiliser votre mot de passe normal</li>
                </ul>
                
                <hr>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Charger les paramètres actuels
    loadSettings();
    
    // Gestion des formulaires
    document.getElementById('network-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveNetworkSettings();
    });
    
    document.getElementById('alert-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveAlertSettings();
    });
    
    document.getElementById('report-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveReportSettings();
    });
    
    document.getElementById('email-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveEmailSettings();
    });
    
    // Test des alertes
    document.getElementById('btn-test-alert').addEventListener('click', function() {
        showAlert('warning', 'Test d\'alerte - Ceci est un message de test');
    });
    
    document.getElementById('btn-test-email').addEventListener('click', function() {
        const email = document.getElementById('alert-email').value;
        if (email) {
            showAlert('info', `Test d'email envoyé à ${email}`);
        } else {
            showAlert('warning', 'Veuillez configurer une adresse email d\'alerte');
        }
    });
    
    // Test configuration email
    document.getElementById('btn-test-email-config').addEventListener('click', function() {
        testEmailConfiguration();
    });
    
    document.getElementById('btn-send-test-alert').addEventListener('click', function() {
        sendTestAlert();
    });
    
    // Synchronisation des champs email
    document.getElementById('alert-email').addEventListener('input', function() {
        const simpleEmail = this.value;
        if (simpleEmail) {
            document.getElementById('to-email').value = simpleEmail;
        }
    });
    
    document.getElementById('to-email').addEventListener('input', function() {
        const smtpEmail = this.value;
        if (smtpEmail) {
            document.getElementById('alert-email').value = smtpEmail;
        }
    });
    
    // Actions système
    document.getElementById('btn-backup').addEventListener('click', function() {
        showAlert('info', 'Sauvegarde de la base de données en cours...');
    });
    
    document.getElementById('btn-clear-cache').addEventListener('click', function() {
        if (confirm('Voulez-vous vraiment vider le cache ?')) {
            showAlert('success', 'Cache vidé avec succès');
        }
    });
    
    document.getElementById('btn-reset-settings').addEventListener('click', function() {
        if (confirm('ATTENTION: Cette action réinitialisera tous les paramètres. Continuer ?')) {
            showAlert('warning', 'Paramètres réinitialisés aux valeurs par défaut');
            loadSettings();
        }
    });
    
    function loadSettings() {
        // Simuler le chargement des paramètres depuis l'API
        fetch('/api/settings')
            .then(response => response.json())
            .then(settings => {
                document.getElementById('network-range').value = settings.network_range || '192.168.1.0/24';
                document.getElementById('scan-interval').value = settings.scan_interval || 60;
                
                // Mettre à jour les informations réseau
                updateNetworkInfo(settings.network_range || '192.168.1.0/24');
            })
            .catch(error => {
                console.error('Erreur lors du chargement des paramètres:', error);
            });
        
        // Charger la configuration email
        fetch('/api/settings/email')
            .then(response => response.json())
            .then(emailSettings => {
                document.getElementById('email-enabled').checked = emailSettings.enabled || false;
                document.getElementById('smtp-server').value = emailSettings.smtp_server || 'smtp.gmail.com';
                document.getElementById('smtp-port').value = emailSettings.smtp_port || 587;
                document.getElementById('email-username').value = emailSettings.username || '';
                document.getElementById('from-email').value = emailSettings.from_email || '';
                document.getElementById('to-email').value = emailSettings.to_email || '';
                
                // Synchroniser avec l'email simple
                if (emailSettings.to_email) {
                    document.getElementById('alert-email').value = emailSettings.to_email;
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement de la config email:', error);
            });
    }
    
    function saveNetworkSettings() {
        const settings = {
            network_range: document.getElementById('network-range').value,
            scan_interval: parseInt(document.getElementById('scan-interval').value),
            scan_timeout: parseInt(document.getElementById('scan-timeout').value),
            max_retries: parseInt(document.getElementById('max-retries').value),
            enable_auto_scan: document.getElementById('enable-auto-scan').checked
        };
        
        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Paramètres réseau sauvegardés avec succès');
                updateNetworkInfo(settings.network_range);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'Erreur lors de la sauvegarde: ' + error.message);
        });
    }
    
    function saveAlertSettings() {
        const settings = {
            alert_threshold: parseInt(document.getElementById('alert-threshold').value),
            alert_device_offline: document.getElementById('alert-device-offline').checked,
            alert_device_online: document.getElementById('alert-device-online').checked,
            alert_low_uptime: document.getElementById('alert-low-uptime').checked,
            alert_scan_failed: document.getElementById('alert-scan-failed').checked
        };
        
        // Sauvegarder l'email simple
        const alertEmail = document.getElementById('alert-email').value;
        if (alertEmail) {
            fetch('/api/settings/alert-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ alert_email: alertEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert('success', 'Paramètres d\'alertes et email sauvegardés avec succès');
                } else {
                    showAlert('danger', data.message || 'Erreur lors de la sauvegarde');
                }
            })
            .catch(error => {
                showAlert('danger', 'Erreur lors de la sauvegarde: ' + error.message);
            });
        } else {
            showAlert('success', 'Paramètres d\'alertes sauvegardés avec succès');
        }
    }
    
    function saveReportSettings() {
        const settings = {
            auto_report: document.getElementById('auto-report').value,
            report_format: document.getElementById('report-format').value,
            report_time: document.getElementById('report-time').value,
            report_retention: parseInt(document.getElementById('report-retention').value),
            include_charts: document.getElementById('include-charts').checked,
            include_alerts: document.getElementById('include-alerts').checked
        };
        
        showAlert('success', 'Paramètres de rapports sauvegardés avec succès');
    }
    
    function saveEmailSettings() {
        const settings = {
            enabled: document.getElementById('email-enabled').checked,
            smtp_server: document.getElementById('smtp-server').value,
            smtp_port: parseInt(document.getElementById('smtp-port').value),
            username: document.getElementById('email-username').value,
            password: document.getElementById('email-password').value,
            from_email: document.getElementById('from-email').value,
            to_email: document.getElementById('to-email').value
        };
        
        // Synchroniser avec l'email simple
        const simpleEmail = document.getElementById('alert-email').value;
        if (simpleEmail && !settings.to_email) {
            settings.to_email = simpleEmail;
            document.getElementById('to-email').value = simpleEmail;
        }
        
        fetch('/api/settings/email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlert('success', 'Configuration email sauvegardée avec succès');
                // Synchroniser les champs
                if (settings.to_email) {
                    document.getElementById('alert-email').value = settings.to_email;
                }
            } else {
                showAlert('danger', data.message || 'Erreur lors de la sauvegarde');
            }
        })
        .catch(error => {
            showAlert('danger', 'Erreur lors de la sauvegarde: ' + error.message);
        });
    }
    
    function testEmailConfiguration() {
        const button = document.getElementById('btn-test-email-config');
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Test en cours...';
        button.disabled = true;
        
        fetch('/api/settings/email/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlert('success', 'Configuration email testée avec succès ! Vérifiez votre boîte mail.');
            } else {
                showAlert('danger', data.message || 'Erreur lors du test');
            }
        })
        .catch(error => {
            showAlert('danger', 'Erreur lors du test: ' + error.message);
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function sendTestAlert() {
        const button = document.getElementById('btn-send-test-alert');
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Envoi...';
        button.disabled = true;
        
        const testData = {
            subject: 'Test d\'alerte Central Danone',
            message: 'Ceci est un test d\'alerte pour vérifier la configuration email du système de supervision Central Danone.',
            priority: 'medium'
        };
        
        fetch('/api/settings/email/alert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlert('success', 'Alerte de test envoyée ! Vérifiez votre boîte mail.');
            } else {
                showAlert('danger', data.message || 'Erreur lors de l\'envoi');
            }
        })
        .catch(error => {
            showAlert('danger', 'Erreur lors de l\'envoi: ' + error.message);
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function updateNetworkInfo(networkRange) {
        // Simuler l'analyse de la plage réseau
        const parts = networkRange.split('/');
        const ip = parts[0];
        const cidr = parseInt(parts[1]);
        
        document.getElementById('current-network').textContent = networkRange;
        document.getElementById('current-mask').textContent = calculateSubnetMask(cidr);
        document.getElementById('current-addresses').textContent = Math.pow(2, 32 - cidr) - 2;
    }
    
    function calculateSubnetMask(cidr) {
        const mask = (0xffffffff >> (32 - cidr)) << (32 - cidr);
        return [
            (mask >> 24) & 0xff,
            (mask >> 16) & 0xff,
            (mask >> 8) & 0xff,
            mask & 0xff
        ].join('.');
    }
    
    // Mise à jour du temps jusqu'au prochain scan
    function updateNextScan() {
        const interval = parseInt(document.getElementById('scan-interval').value);
        const nextScan = new Date(Date.now() + interval * 60 * 1000);
        const minutes = Math.floor((nextScan - Date.now()) / (1000 * 60));
        
        if (minutes > 60) {
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            document.getElementById('next-scan').textContent = `${hours}h ${remainingMinutes}min`;
        } else {
            document.getElementById('next-scan').textContent = `${minutes} min`;
        }
    }
    
    // Mettre à jour toutes les minutes
    setInterval(updateNextScan, 60000);
    updateNextScan();
});
</script>
{% endblock %} 